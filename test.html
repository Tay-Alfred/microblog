<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts Page</title>
    <style>
        .message {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
        }
        .message h1 {
            font-size: 1.5em;
        }
        .username, .createdAt, .ID, .Likes {
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div id="postForm">
        <textarea id="messageElement" placeholder="Write your message..."></textarea>
        <button id="buttonPostMessage">Post Message</button>
    </div>
    <div id="messagesOutput"></div>

    <script>
        const apiBaseURL = "http://microbloglite.us-east-2.elasticbeanstalk.com/"; // Replace with your actual API base URL
        const buttonPostMessage = document.getElementById("buttonPostMessage");
        const messageElement = document.getElementById("messageElement");
        const messagesOutput = document.getElementById("messagesOutput");

        function like(postId) {
            fetch(apiBaseURL + "/api/likes", {
                method: "POST",
                headers: {
                    accept: "application/json",
                    "Content-Type": "application/json",
                    Authorization: "Bearer " + localStorage.token
                },
                body: JSON.stringify({ postId: postId })
            }).then(response => {
                console.log(response);
                location = "/posts/";  // force refresh
            });
        }

        buttonPostMessage.addEventListener("click", e => {
            fetch(apiBaseURL + "/api/posts", {
                method: "POST",
                headers: {
                    accept: "application/json",
                    "Content-Type": "application/json",
                    Authorization: "Bearer " + localStorage.token
                },
                body: JSON.stringify({ text: messageElement.value })
            }).then(response => {
                console.log(response);
                location = "/posts/";  // force refresh
            });
        });

        function getMessage(message) {
            return /*html*/`
            <div class="message">
                <h1>${message.text}</h1>
                <div class="username">${message.username}</div>
                <div class="createdAt">${message.createdAt}</div>
                <div class="ID">${message._id}</div>
                <div class="Likes">${message.likes.length} Likes 
                    <button onclick="like('${message._id}')">Like</button>
                </div>
            </div>
            <hr>`;
        }

        function showMessages(messages) {
            if (messages.hasOwnProperty("message")) {
                location = "/";
                return;
            }
            messagesOutput.innerHTML = messages.map(getMessage).join("");
        }

        fetch(apiBaseURL + "/api/posts", {
            method: "GET",
            headers: { Authorization: `Bearer ${localStorage.token}` }
        }).then(response => {
            if (response.status >= 400) {
                console.log(response);
                location = "/";
            }
            return response.json();
        }).then(data => {
            showMessages(data);
        });
    </script>
</body>
</html>
